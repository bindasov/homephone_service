# Homephone Service Project

## Описание

Проект **Homephone Service** представляет собой систему, включающую несколько микросервисов, каждый из которых выполняет свою уникальную функцию. Эти сервисы взаимодействуют друг с другом через API и управляются с использованием Docker и Docker Compose.

Каждый сервис в проекте отвечает за свою часть функционала:

- **API Gateway** — управляет запросами от клиентов и маршрутизирует их между сервисами.
- **User Service** — управляет пользователями, их данными и операциями.
- **Call Service** — обрабатывает логику и операции, связанные с телефонными вызовами.
- **Call Cache Service** — кеширует данные для более быстрого доступа.
- **Logging Service** — собирает и хранит логи всех операций в системе.
- **Nginx** — используется для обратного прокси и балансировки нагрузки.

## Структура проекта

```plaintext
homephone_service/
├── api_gateway/                 <-- Управляет запросами API и маршрутизацией
│   ├── .env                     <-- Переменные окружения
│   ├── dockerfile               <-- Docker конфигурация для api_gateway
│   ├── main.py                  <-- Основная точка входа для API шлюза
│   └── requirements.txt         <-- Зависимости Python для api_gateway
│
├── call_service/                <-- Обрабатывает логику и операции, связанные с вызовами
│   ├── .env                     <-- Переменные окружения
│   ├── dockerfile               <-- Docker конфигурация для call_service
│   ├── main.py                  <-- Основная логика для сервиса вызовов
│   ├── models.py                <-- Модели базы данных для сервиса вызовов
│   └── requirements.txt         <-- Зависимости Python для call_service
│
├── callcache_service/           <-- Кеширует вызовы для быстрого доступа
│   ├── .env                     <-- Переменные окружения
│   ├── dockerfile               <-- Docker конфигурация для callcache_service
│   ├── main.py                  <-- Основная логика для сервиса кеширования вызовов
│   ├── models.py                <-- Модели базы данных для кеширования вызовов
│   └── requirements.txt         <-- Зависимости Python для callcache_service
│
├── logging_service/             <-- Отвечает за ведение логов
│   ├── .env                     <-- Переменные окружения
│   ├── dockerfile               <-- Docker конфигурация для logging_service
│   ├── main.py                  <-- Основная логика для сервиса логирования
│   ├── models.py                <-- Модели базы данных для сервиса логирования
│   └── requirements.txt         <-- Зависимости Python для logging_service
│
├── nginx/                       <-- Веб-сервер для обратного прокси и балансировки нагрузки
│   ├── dockerfile               <-- Docker конфигурация для nginx
│   └── nginx.conf               <-- Конфигурация Nginx
│
├── user_service/                <-- Управляет функциональностью, связанной с пользователями
│   ├── .env                     <-- Переменные окружения
│   ├── dockerfile               <-- Docker конфигурация для user_service
│   ├── main.py                  <-- Основная логика для сервиса пользователей
│   ├── models.py                <-- Модели базы данных для сервиса пользователей
│   └── requirements.txt         <-- Зависимости Python для user_service
│
├── .gitignore                   <-- Файл для игнорирования Git
└── docker-compose.yml           <-- Конфигурация Docker Compose для оркестрации сервисов
```

### Объяснение:

- **Установка** — Даны пошаговые инструкции по клонированию репозитория, установке зависимостей и запуску проекта.
Даны пошаговые инструкции по клонированию репозитория, установке зависимостей и запуску проекта:

1. Клонируйте репозиторий на вашу локальную машину:

    ```bash
    git clone https://github.com/yourusername/homephone_service.git
    cd homephone_service
    ```

2. Убедитесь, что у вас установлен Docker и Docker Compose. Если они не установлены, следуйте [официальной документации Docker](https://docs.docker.com/) для их установки.

3. Создайте `.env` файлы для каждого сервиса. Пример файла `.env` можно найти в каждом каталоге, таком как `api_gateway/.env`, `user_service/.env` и других. Внесите необходимые переменные окружения.

4. Запустите проект с помощью Docker Compose:

    ```bash
    docker-compose up --build
    ```

5. После запуска сервисов откройте браузер и перейдите по адресу [http://localhost](http://localhost), чтобы проверить работу API Gateway.

- **Описание сервисов** — Детальное описание каждого сервиса в проекте.

### API Gateway
Сервис маршрутизации запросов между различными микросервисами. Он принимает запросы от клиентов и перенаправляет их в соответствующие сервисы, такие как `user_service`, `call_service` и другие.

### Маршруты API

#### Пользователи (`User Service`)
- **GET /**  
  Получить главную страницу User Service.

- **GET /users/**  
  Получить список всех пользователей.

- **GET /users/{id}**  
  Получить информацию о пользователе по ID.  
  - Параметры:  
    - `id` (int): Идентификатор пользователя.

- **POST /users/**  
  Создать нового пользователя.  
  - Тело запроса (JSON):  
    ```json
    {"name": "Alice", "phone": "+123456789"}
    ```

- **DELETE /users/{id}**  
  Удалить пользователя по ID.  
  - Параметры:  
    - `id` (int): Идентификатор пользователя.

---

#### Звонки (`Call Service`)
- **POST /calls/**  
  Инициировать звонок.  
  - Тело запроса (JSON):  
    ```json
    {"username": "Alice", "destination": "+987654321"}
    ```

- **GET /calls/history/**  
  Получить историю звонков.

- **GET /calls/history/last/**  
  Получить информацию о последнем звонке.

---

#### Логи (`Logging Service`)
- **GET /logs/calls/**  
  Получить логи звонков за период времени.  
  - Параметры:  
    - `start_date` (str): Начальная дата (формат `YYYY-MM-DD`).  
    - `end_date` (str): Конечная дата (формат `YYYY-MM-DD`).

- **GET /logs/users/**  
  Получить логи пользователей за период времени.  
  - Параметры:  
    - `start_date` (str): Начальная дата (формат `YYYY-MM-DD`).  
    - `end_date` (str): Конечная дата (формат `YYYY-MM-DD`).

---

### User Service
Этот сервис управляет пользователями. Он предоставляет API для выполнения следующих операций:

#### Основной маршрут
- **GET /**  
  Возвращает приветственное сообщение.

#### Пользователи

- **POST /users/**  
  Создает нового пользователя.  
  Ожидает JSON-данные:
  ```json
  {
    "name": "Alice",
    "phone": "123456789"
  }
  ```
  - **name** (str, обязательный): Имя пользователя.
  - **phone** (str, обязательный): Телефон пользователя.
  
  Возвращает:
  ```json
  {
    "id": 1,
    "name": "Alice",
    "phone": "123456789"
  }
  ```
  - **id** (int): Идентификатор пользователя.
  - **name** (str): Имя пользователя.
  - **phone** (str): Телефон пользователя.

- **GET /users/**  
  Получить список всех пользователей.  
  Возвращает:
  ```json
  [
    {
      "id": 1,
      "name": "Alice",
      "phone": "123456789"
    },
    {
      "id": 2,
      "name": "Bob",
      "phone": "987654321"
    }
  ]
  ```

- **GET /users/{id}**  
  Получить информацию о пользователе по ID.  
  Возвращает:
  ```json
  {
    "id": 1,
    "name": "Alice",
    "phone": "123456789"
  }
  ```
  Если пользователь не найден, возвращает ошибку:
  ```json
  {
    "message": "User not found"
  }
  ```

- **DELETE /users/{id}**  
  Удалить пользователя по ID.  
  Возвращает:
  ```json
  {
    "message": "User deleted successfully."
  }
  ```
  Если пользователь не найден, возвращает ошибку:
  ```json
  {
    "message": "User not found!"
  }
  ```


---

### Call Service
Сервис, обрабатывающий логику и операции, связанные с телефонными вызовами. Он включает обработку данных вызовов и хранение информации о вызовах.

### Маршруты API

#### Основной маршрут
- **GET /**  
  Возвращает приветственное сообщение.  

#### Звонки
- **POST /call/**  
  Создать запись о новом звонке.  
  - Ожидает JSON-данные:  
    ```json
    {
      "username": "Alice",
      "status": "completed", 
      "date": "2024-11-27T15:30:00"
    }
    ```
    - `username` (str, обязательный): Имя пользователя, совершившего звонок.  
    - `status` (str, обязательный): Статус звонка (`completed`, `false`, `yes`, и т. д.). Приводится к булевому типу.  
    - `date` (str, необязательный): Дата звонка в формате ISO 8601. Если не указана, используется текущая дата и время.  

  - Возвращает:  
    ```json
    {
      "id": 1,
      "username": "Alice",
      "date": "2024-11-27T15:30:00",
      "status": true
    }
    ```
    - `id` (int): Идентификатор звонка.  
    - `username` (str): Имя пользователя.  
    - `date` (str): Дата звонка.  
    - `status` (bool): Статус звонка.  

#### История звонков
- **GET /call/history/**  
  Получить всю историю звонков.  
  - Возвращает список звонков:  
    ```json
    [
      {
        "id": 1,
        "username": "Alice",
        "date": "2024-11-27T15:30:00",
        "status": true
      },
      {
        "id": 2,
        "username": "Bob",
        "date": "2024-11-26T14:20:00",
        "status": false
      }
    ]
    ```

- **GET /call/history/last/**  
  Получить информацию о последнем звонке.  
  - Возвращает данные последнего звонка:  
    ```json
    {
      "id": 2,
      "username": "Bob",
      "date": "2024-11-26T14:20:00",
      "status": false
    }
    ```
  - Если звонков нет, возвращает:  
    ```json
    {
      "message": "No calls found."
    }
    ```
    - Статус ответа: 404.  

---

### Call Cache Service
Сервис используется для кеширования данных о вызовах, что позволяет ускорить доступ к часто запрашиваемой информации.

### Маршруты API

#### Основной маршрут
- **GET /**  
  Возвращает приветственное сообщение.

#### Кэширование пользователя
- **POST /cache/user**  
  Кэширует данные пользователя в Redis.  
  - Ожидает JSON-данные:
    ```json
    {
      "username": "Alice",
      "phone": "+1234567890"
    }
    ```
    - `username` (str, обязательный): Имя пользователя.  
    - `phone` (str, обязательный): Телефон пользователя.  

  - Возвращает:
    ```json
    {
      "message": "User Alice cached successfully!"
    }
    ```

- **GET /cache/user**  
  Извлекает данные пользователя из Redis по имени.  
  - Ожидает параметр `username` в запросе.  
  - Пример запроса: `/cache/user?username=Alice`

  - Возвращает:
    ```json
    {
      "username": "Alice",
      "phone": "+1234567890"
    }
    ```
  - Если пользователь не найден, возвращает:
    ```json
    {
      "message": "User Alice not found in cache!"
    }
    ```
    - Статус ответа: 404.  

#### Кэширование звонка
- **POST /cache/call**  
  Кэширует данные звонка в Redis.  
  - Ожидает JSON-данные:
    ```json
    {
      "username": "Alice",
      "date": "2024-11-27T15:30:00",
      "status": "completed"
    }
    ```
    - `username` (str, обязательный): Имя пользователя.  
    - `date` (str, обязательный): Дата звонка в формате ISO 8601.  
    - `status` (str, обязательный): Статус звонка (`completed`, `false`, `yes`, и т. д.).  

  - Возвращает:
    ```json
    {
      "message": "Call data for Alice cached successfully!"
    }
    ```

- **GET /cache/call**  
  Извлекает данные звонка из Redis по имени пользователя и дате.  
  - Ожидает параметры `username` и `date` в запросе.  
  - Пример запроса: `/cache/call?username=Alice&date=2024-11-27T15:30:00`

  - Возвращает:
    ```json
    {
      "username": "Alice",
      "date": "2024-11-27T15:30:00",
      "status": "completed"
    }
    ```
  - Если звонок не найден, возвращает:
    ```json
    {
      "message": "Call data for Alice on 2024-11-27T15:30:00 not found in cache!"
    }
    ```
    - Статус ответа: 404.

---

### Logging Service
Сервис для ведения логов. Он отслеживает все действия, происходящие в других сервисах, и сохраняет информацию о событиях.

### Маршруты API

#### Основной маршрут
- **GET /**  
  Возвращает приветственное сообщение.

#### Запись лога пользователя
- **POST /log/user**  
  Записывает лог действия пользователя в базу данных.  
  - Ожидает JSON-данные:
    ```json
    {
      "username": "Alice",
      "action": "Logged in"
    }
    ```
    - `username` (str, обязательный): Имя пользователя.  
    - `action` (str, обязательный): Действие, которое совершил пользователь (например, "Logged in", "Logged out").  

  - Возвращает:
    ```json
    {
      "message": "User log for Alice recorded!"
    }
    ```

#### Запись лога звонка
- **POST /log/call**  
  Записывает лог звонка в базу данных.  
  - Ожидает JSON-данные:
    ```json
    {
      "username": "Alice",
      "call_duration": 120,
      "status": "completed"
    }
    ```
    - `username` (str, обязательный): Имя пользователя.  
    - `call_duration` (int, обязательный): Длительность звонка в секундах.  
    - `status` (str, обязательный): Статус звонка (например, "completed", "failed").  

  - Возвращает:
    ```json
    {
      "message": "Call log for Alice recorded!"
    }
    ```

#### Получение логов звонков за период времени
- **GET /log/calls/**  
  Извлекает логи звонков за заданный период времени.  
  - Ожидает параметры:
    - `start_date` (str, обязательный): Начало периода (в формате `YYYY-MM-DDTHH:MM:SS`).
    - `end_date` (str, обязательный): Конец периода (в формате `YYYY-MM-DDTHH:MM:SS`).

  - Пример запроса:
    ```
    /log/calls?start_date=2024-11-01T00:00:00&end_date=2024-11-30T23:59:59
    ```

  - Возвращает:
    ```json
    [
      {
        "username": "Alice",
        "call_duration": 120,
        "status": "completed",
        "timestamp": "2024-11-10T12:30:00"
      },
      {
        "username": "Bob",
        "call_duration": 90,
        "status": "failed",
        "timestamp": "2024-11-11T14:15:00"
      }
    ]
    ```

  - Если нет данных, возвращает:
    ```json
    {
      "message": "No logs found for the given period."
    }
    ```

#### Получение логов действий пользователей за период времени
- **GET /log/users/**  
  Извлекает логи действий пользователей за заданный период времени.  
  - Ожидает параметры:
    - `start_date` (str, обязательный): Начало периода (в формате `YYYY-MM-DDTHH:MM:SS`).
    - `end_date` (str, обязательный): Конец периода (в формате `YYYY-MM-DDTHH:MM:SS`).

  - Пример запроса:
    ```
    /log/users?start_date=2024-11-01T00:00:00&end_date=2024-11-30T23:59:59
    ```

  - Возвращает:
    ```json
    [
      {
        "username": "Alice",
        "action": "Logged in",
        "timestamp": "2024-11-10T12:30:00"
      },
      {
        "username": "Bob",
        "action": "Logged out",
        "timestamp": "2024-11-11T14:15:00"
      }
    ]
    ```

  - Если нет данных, возвращает:
    ```json
    {
      "message": "No logs found for the given period."
    }
    ```
